<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="csrf-token" content="" id="csrf-token" />
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, proxy-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ePOS-領収書印刷</title>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script type="text/javascript">
<!--
    let CONFIG = {};
    let currentUser = null;

    async function loadConfig() {
        try {
            const response = await fetch('./config/config.json');
            if (!response.ok) {
                throw new Error('設定ファイルの読み込みに失敗しました');
            }
            CONFIG = await response.json();

            const firebaseConfig = {
                apiKey: CONFIG.firebaseApiKey,
                authDomain: CONFIG.firebaseAuthDomain,
                projectId: CONFIG.firebaseProjectId
            };

            firebase.apps.forEach(app => app.delete());

            firebase.initializeApp(firebaseConfig);

            checkAuthState();
            document.getElementById('amount').value = CONFIG.amount;
            updateConfigDisplay();
        } catch (error) {
            console.error('設定読み込みエラー:', error);
            alert('設定ファイルの読み込みに失敗しました: ' + error.message);
        }
    }

    function checkAuthState() {
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const response = await fetch('./config/config.json');
                    const config = await response.json();

                    if (config.allowedEmails.includes(user.email)) {
                        currentUser = user;
                        document.getElementById('loginStatus').textContent =
                            `ログイン中: ${user.email}`;
                        document.getElementById('printButton').disabled = false;
                    } else {
                        await firebase.auth().signOut();
                        alert('このメールアドレスには操作権限がありません');
                        document.getElementById('loginStatus').textContent =
                            'ログインしていません';
                        document.getElementById('printButton').disabled = true;
                    }
                } catch (error) {
                    console.error('設定読み込みエラー:', error);
                    alert('設定の読み込みに失敗しました');
                }
            } else {
                currentUser = null;
                document.getElementById('loginStatus').textContent =
                    'ログインしていません';
                document.getElementById('printButton').disabled = true;
            }
        });
    }

    async function login() {
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await firebase.auth().signInWithPopup(provider);
        } catch (error) {
            console.error('ログインエラー:', error);
            alert('ログインに失敗しました: ' + error.message);
        }
    }

    async function logout() {
        try {
            await firebase.auth().signOut();
        } catch (error) {
            console.error('ログアウトエラー:', error);
            alert('ログアウトに失敗しました: ' + error.message);
        }
    }

    window.onload = loadConfig;

    function updateConfigDisplay() {
        const currentTime = formatDateTime(new Date());
        document.getElementById('currentConfig').textContent =
            `現在の設定: IP=${CONFIG.printerIP}, 金額=${CONFIG.amount}円, UUID=${CONFIG.uuid || '未生成'}, 時刻=${currentTime}`;
    }

    async function generateUUIDv7() {
        try {
            const response = await fetch('./api/generate-uuid');
            if (!response.ok) {
                throw new Error(`UUIDの取得に失敗しました (${response.status})`);
            }
            const data = await response.json();
            if (!data.uuid) {
                throw new Error('無効なUUIDレスポンス');
            }
            return data.uuid;
        } catch (error) {
            console.error('UUID取得エラー:', error);
            alert('UUIDの取得に失敗しました: ' + error.message);
            throw error;
        }
    }

    function getPrinterUrl() {
        return `${CONFIG.protocol}://${CONFIG.printerIP}/cgi-bin/epos/service.cgi?devid=${CONFIG.devid}&timeout=10000`;
    }

    function validateAmount(value) {
        const amount = parseInt(value);
        if (isNaN(amount) || amount > 20000 || amount < 0) {
            alert('金額は0から20,000円の間で入力してください。');
            return false;
        }
        return true;
    }

    function formatDateTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        const weekday = weekdays[date.getDay()];
        return `${year}年${month}月${day}日(${weekday})${hours}:${minutes}`;
    }

    async function updateConfig() {
        const newAmount = document.getElementById('amount').value;
        if (!validateAmount(newAmount)) return;

        CONFIG.amount = newAmount;
        CONFIG.uuid = await generateUUIDv7();

        updateConfigDisplay();
    }

    function formatAmountWithComma(amount) {
        const numStr = amount.toString();
        let result = '';
        for (let i = 0; i < numStr.length; i++) {
            result += String.fromCharCode('０'.charCodeAt(0) + parseInt(numStr[i]));
            if ((numStr.length - i - 1) % 3 === 0 && i < numStr.length - 1) {
                result += '，';
            }
        }
        return `￥${result}－`;
    }

    async function button1_Click() {
        if (!currentUser) {
            alert('ログインが必要です');
            return;
        }

        try {
            const idToken = await currentUser.getIdToken();
            const printButton = document.querySelector('button');
            printButton.disabled = true;

            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

            await updateConfig();
            const url = getPrinterUrl();
            console.log('プリンターURL:', url);

            const currentDateTime = formatDateTime(new Date());

            const formattedAmount = formatAmountWithComma(CONFIG.amount);
            var req =
                '<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">' +
                '<s:Body>' +
                    '<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print">' +
                    '<text lang="ja"/>' +
                    '<text smooth="true"/>' +
                    '<text align="center"/>' +
                    `<symbol type="pdf417_standard" level="level_5" width="0" height="4" size="0">${CONFIG.uuid}</symbol>` +
                    '<page>' +
                    '<area x="0" y="0" width="550" height="870"/>' +
                    '<direction dir="top_to_bottom"/>' +
                    '<position x="80" y="80"/>' +
                    '<text font="font_c"/>' +
                    '<text dw="true" dh="true"/>' +
                    '<text>領   収   証</text>' +
                    '<position x="80" y="210"/>' +
                    '<text reverse="false" ul="true" em="true" color="color_1"/>' +
                    '<text>　　　　　　　様</text>' +
                    '<position x="130" y="320"/>' +
                    `<text>${formattedAmount}</text>` +
                    '<text reverse="false" ul="false" em="false" color="color_1"/>' +
                    '<text dw="false" dh="false"/>' +
                    '<position x="60" y="380"/>' +
                    '<text>但し、お品代として</text>' +
                    '<position x="60" y="410"/>' +
                    '<text>上記正に領収いたしました。</text>' +
                    '<position x="40" y="490"/>' +
                    '<text font="font_a"/>' +
                    '<text>UUID(v7):</text>' +
                    '<position x="40" y="520"/>' +
                    `<text>${CONFIG.uuid}</text>` +
                    '<position x="530" y="80"/>' +
                    `<text>${currentDateTime}</text>` +
                    '<position x="600" y="180"/>' +
                    `<symbol type="qrcode_model_2" level="level_h" width="3" height="0" size="0">${CONFIG.receiptURL}${CONFIG.uuid}</symbol>` +
                    '<position x="530" y="440"/>' +
                    `<text>${CONFIG.issuerName}</text>` +
                    '<position x="530" y="490"/>' +
                    `<text>${CONFIG.address}</text>` +
                    '<position x="530" y="520"/>' +
                    `<text>TEL ${CONFIG.phone}</text>` +
                    '</page>' +
                    '<text rotate="true"/>' +
                    `<symbol type="pdf417_standard" level="level_5" width="0" height="4" size="0">${CONFIG.uuid}</symbol>` +
                    '<cut type="feed"/>' +
                    '</epos-print>' +
                '</s:Body>' +
                '</s:Envelope>';

            // 印刷ドキュメントの送信
            var xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            xhr.withCredentials = true;
            xhr.setRequestHeader('Content-Type', 'text/xml; charset=utf-8');
            xhr.setRequestHeader('If-Modified-Since', 'Thu, 01 Jan 1970 00:00:00 GMT');
            xhr.setRequestHeader('SOAPAction', '""');
            xhr.setRequestHeader('X-CSRF-Token', csrfToken);
            process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';

            xhr.onreadystatechange = async function () {
                if (xhr.readyState == 4) {
                    printButton.disabled = false;

                    if (xhr.status == 200) {
                        const response = xhr.responseXML;
                        console.log('プリンターレスポンス:', response);

                        if (response && response.getElementsByTagName('response')[0]) {
                            const success = response.getElementsByTagName('response')[0].getAttribute('success');
                            if (success === 'true') {
                                try {
                                    const saveResponse = await fetch('/api/save-receipt', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${idToken}`
                                        },
                                        body: JSON.stringify({
                                            uuid: CONFIG.uuid,
                                            amount: CONFIG.amount,
                                            datetime: currentDateTime,
                                            phone: CONFIG.phone,
                                            address: CONFIG.address,
                                            issuerName: CONFIG.issuerName
                                        })
                                    });

                                    if (!saveResponse.ok) {
                                        throw new Error('印刷データの保存に失敗しました');
                                    }
                                    alert('印刷が完了しました');
                                } catch (saveError) {
                                    console.error('データ保存エラー:', saveError);
                                    alert('印刷は成功しましたが、データの保存に失敗しました: ' + saveError.message);
                                }
                            } else {
                                const code = response.getElementsByTagName('response')[0].getAttribute('code');
                                const status = response.getElementsByTagName('response')[0].getAttribute('status');
                                console.error('印刷エラー:', { code, status });
                                alert(`印刷に失敗しました (エラーコード: ${code}, ステータス: ${status})`);
                            }
                        } else {
                            console.error('不正なレスポンス形式:', xhr.responseText);
                            alert('プリンターから不正なレスポンスを受信しました');
                        }
                    } else {
                        console.error('HTTPエラー:', xhr.status, xhr.statusText);
                        console.error('レスポンス:', xhr.responseText);
                        alert(`ネットワークエラーが発生しました (${xhr.status}: ${xhr.statusText})`);
                    }
                }
            };

            xhr.onerror = function(error) {
                console.error('XHRエラー:', error);
                printButton.disabled = false;
                alert('プリンターとの通信に失敗しました');
            };

            console.log('リクエスト送信:', req);
            xhr.send(req);
        } catch (error) {
            console.error('エラーが発生しました:', error);
            alert('エラーが発生しました: ' + error.message);
            document.querySelector('button').disabled = false;
        }
    }

//-->
</script>
</head>

<body>
    <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
        <div id="loginStatus" style="margin-bottom: 20px;"></div>
        <button onclick="login()">ログイン</button>
        <button onclick="logout()">ログアウト</button>

        <h2>設定</h2>
        <div style="margin-bottom: 20px;">
            <label>金額：</label>
            <input type="number" id="amount" value="20000" max="20000"><br>
        </div>

        <div id="currentConfig" style="margin-bottom: 20px;"></div>

        <div style="text-align: center;">
            <button id="printButton" onclick="button1_Click()" style="padding: 10px 20px;" disabled>印刷</button>
        </div>
    </div>

    <script>
        const observer = new MutationObserver(updateConfigDisplay);
        observer.observe(document.getElementById('currentConfig'), {
            childList: true,
            subtree: true,
            characterData: true
        });
    </script>
</body>
</html>
